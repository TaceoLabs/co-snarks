mod circom_reduction;
pub mod circuit;

#[cfg(test)]
mod tests {
    use ark_bls12_381::Bls12_381;
    use ark_bn254::Bn254;
    use ark_ec::pairing::Pairing;
    use ark_ff::UniformRand;
    use ark_groth16::{prepare_verifying_key, Groth16};
    use circom_types::{
        groth16::{
            proof::JsonProof, public_input::JsonPublicInput, verification_key::JsonVerificationKey,
            witness::Witness, zkey::ZKey,
        },
        r1cs::R1CS,
    };
    use hex_literal::hex;
    use rand::thread_rng;
    use std::io::Cursor;

    use crate::{circom_reduction::CircomReduction, circuit::Circuit};

    #[test]
    fn create_proof_and_verify_bn254() {
        let mut witness_bytes = Cursor::new(hex!("77746e73020000000200000001000000280000000000000020000000010000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430040000000200000080000000000000000100000000000000000000000000000000000000000000000000000000000000210000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000"));
        let mut zkey_bytes = Cursor::new(hex!("7a6b6579010000000a000000010000000400000000000000010000000200000094020000000000002000000047fd7cd8168c203c8dca7168916a81975d588181b64550b829a031e1724e643020000000010000f093f5e1439170b97948e833285d588181b64550b829a031e1724e643004000000010000000400000073d28cba1705727b300c4d4f26b7d77b71c1b109c303f566ee57eadabd6c8313f588a3f993020cc302fc175234fddab40d21651861ae718eccf741fa05176000d04a4f69a9f8bad681ce0acbe902b1f02e14a878ebb7bc908a38ee6f18939308a6c2ad63161ac72c6cc5c85e203a2abf11d61a10efbc34aef4602f22abb5b01b42f07aa08bb3808c929049045f73ed151ea66719b6bfa69c1513ae79087b1b2c69dc0d9c5613c4b69113b4272f3d0faa3c28b56f165e77b1e86c5733681ddf2a7986f829092e149fb023795de98714347245f2378004bedcf3d8431cf747fd2f71aaa81d47be705f008d0f4c0daa9a15057f2f763118773b5dced0950638d8122620bc02d1b5838e72017b493519ebdcdf1a81974726b8fb3b5096af4138571940614ca87d73b4afc4d802585add4360862fa052fc50e9096b7bea3a83f0fe14f6e96b889dfa9d61789b9ef597d27ffefe7d1b23621a9eff06429eaeeb7efd28ee5618c7565b0964bb3c7d3222f957dc76103533be35f9558264fd93e6a0a40da36f7a3fcaa31639fa1de4e9340a728b606ea769b89403399127030df1a036216267c0c710c65477c42f56e98f68002f795bf7cb3c30bfee7f81049dc7d9581a8b47c02966db6e8dd919cf5621e05ba837d74b70a04dbee16b1965275a368a163b9594c507975fa54f69735161cef3233412da21b07411ee18371c45f64c76223ca9402b2396a4ed245a18cd6c1902d45f9b248c785d0c37ec726c85254cab0bbe68bd5b0219638e3b0a2060a2b4e6c577a4126d9942951cdf38e4e827ad4b1b03000000800000000000000016099153f2fd411668c740ad20fec7945d0469594689b902ba7383d092a95006ac52855e3b00774d0acf93ddc5b5738a5637d1714473992acc1e1906e205152a8d0a6a7d9511bd4f4ccf8e2662f8f78780ccfafefe8b05369b6c10836ec599235ed8db8d3ac77b1ed3e26dcb77626be0a2dc3c76b2e2278bd4b155aefddf591d04000000b400000000000000040000000000000000000000020000005a92de414e0f2928ae165d9696ad35d4d7d7c52d79c2062c845be361c17d4d2e010000000000000003000000a76d21ae45e6b81be3595ce3b13afe538580bb533d83498ca5444e7fb1d01602000000000100000000000000a76d21ae45e6b81be3595ce3b13afe538580bb533d83498ca5444e7fb1d01602000000000200000001000000a76d21ae45e6b81be3595ce3b13afe538580bb533d83498ca5444e7fb1d016020500000000010000000000008cf61e3a4aa13425775d5ff08202404060925a652bc93e9a7fc5a7593730be2d712cc7faad322531c590fee8cd90afd05dd28ddd00a7f33b77fdee221dffa317558150d964f094187748565ee4dd8929efec7ff8468ca8defa02476c731d1e2d03347af66d3e0cf5d4ff5c2444302c43330d87881fc9474b3cd4b7f8f86a881a01338ecb9fd282ef5b90ff41e0173348272412e4fb403d2dd5e0dee71f790b1df4ba4803e6aa4fb0d4051225f55c17df12a8ee32172348d17ccbc93459d7eb160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001338ecb9fd282ef5b90ff41e0173348272412e4fb403d2dd5e0dee71f790b1d534234d530e1d08bb8c45f439c0d6ab84ab0924e9f2208e7acd467ac19777819070000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000552245583201c98d7e1d08be9f26a3b9741d48abb18cbb14c67929066f059a034e3327877ae56e1aff8bbfef09551f809abf656dc9abd20e273aaeda85232a14129d38287e07151d25f31c778ab5b3657d59c19f150e61876a41b915cbdbca11daf37d8c7bf8f354dca303a98c9a4916503e4dee85362bf61b57bda11b806f240800000080000000000000004ffaff4781a89ece9ba6866cdb8a310b5f418cf8a8ae06c76ffe55b47f59a918d205e885c8d78fc110bc066ae84f3e632a0139d4d6facbffe5a8b6091718aa21f440b75a0a5ff596bbe7efb8f3a8767a051b58059d5414226318fd5f0eed5903c77ff3e2665ef1bb36fc61d11e27a5cac401cd61ecbef354c3abf5037b7f232a090000000001000000000000660e10145ad96f4e9e049664fa3fde9677df302a8f3be6f7d230fd9c846cf4292481e35acf32d5959817e9a4c04403f109270aa36728ea969c31dae19c3d36238d5b74b2ae86124c36821344a0dcc50bb843a81a110beb0c2940bad25fd1fc1679e442b8be0aedc8f8fedbd34145adf4b6d3e1cab91d88c5bc2fa1e969e1d71060420f30f57545215671888d8074e7ef8f192f16b3d344b91f6e3fd83532a4094f386432eb27added390f1e6f907b60056095a1a811cd7a70c5ca1645cbe0b212c0d4f04c7a4ec14a9c7b5c9a4e7a2112960d19936c247d9d15a043dbf3b4006c4122e1f0abd347f1eef092a891febbd5d8ed785777933b75dea34f3ce8416180a000000e201000000000000c593936fa72c57811543a377249ccf8e930f3b74036772a935b5ef5164416c22098a5b38d0915cbf31ec277e212136e3318b49bf16fe23bf5e57df9a138084c601000000a36f7a3fcaa31639fa1de4e9340a728b606ea769b89403399127030df1a036216267c0c710c65477c42f56e98f68002f795bf7cb3c30bfee7f81049dc7d9581ac28c81432d0b083576971fce01f4c40ae5ee7acd9a1c53bdcf980b6b4badfc2a98d525f54bc4803ce585b9266a62783f6ab5fd0562b38ad05ca8e00338f44e030a7c623370149f5bc0689c8ad5e6a0dd2006899f2dfaea834f4fb906d0bb2908f17bb7e0a34b0edfba1e5188c70f11c8f2308b1fca2501c8946d672d850fbf17b423e1daba119931cb528e298790b1c46546b760c6293ff5cbffbc33224e1b029582ba3426a0e01eb7abc4fbdb459bf10b5ae51d111d07f83810e63db429190b283f4c8319bad425baf564ca236a5674c602e0577ac87ef9c2e6a9af6448c40771ef2e39619ee39cb62860541031e1dc9d01fd88ff877504751ce6c4a2490e063b4ceaac015e155eafabdaef755fc8223f8c0dbc839a57736233c4cc89d83f763ff1751cfab0f43a03d4cce60f34456261664a4cae5f45a8c725e2e9b8841e4b0000000016000000011431737420436f6e7472696275746f72204e616d65"));
        let mut r1cs_bytes =  Cursor::new(hex!("7231637301000000030000000200000078000000000000000100000002000000000000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430010000000300000001000000000000000000000000000000000000000000000000000000000000000100000001000000000000f093f5e1439170b97948e833285d588181b64550b829a031e1724e643001000000400000000000000020000000010000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430040000000100000000000000020000000400000000000000010000000300000020000000000000000000000000000000010000000000000002000000000000000300000000000000"));
        let witness = Witness::<ark_bn254::Fr>::from_reader(&mut witness_bytes).unwrap();
        let (pk, _) = ZKey::<Bn254>::from_reader(&mut zkey_bytes).unwrap().split();
        let r1cs = R1CS::<Bn254>::from_reader(&mut r1cs_bytes).unwrap();
        let circuit = Circuit::new(r1cs, witness);
        let public_inputs = circuit.public_inputs();
        let mut rng = thread_rng();
        let r = <Bn254 as Pairing>::ScalarField::rand(&mut rng);
        let s = <Bn254 as Pairing>::ScalarField::rand(&mut rng);
        let proof =
            Groth16::<Bn254, CircomReduction>::create_proof_with_reduction(circuit, &pk, r, s)
                .expect("proof generation works");
        let pvk = prepare_verifying_key(&pk.vk);
        let ser_proof = serde_json::to_string(&JsonProof::<Bn254>::from(proof)).unwrap();
        let der_proof = serde_json::from_str::<JsonProof<Bn254>>(&ser_proof).unwrap();
        let verified = Groth16::<Bn254>::verify_proof(&pvk, &der_proof.into(), &public_inputs)
            .expect("can verify");
        assert!(verified);
    }

    #[test]
    fn verify_circom_proof_bn254() {
        let vk_bytes = hex!("7b0a202270726f746f636f6c223a202267726f74683136222c0a20226375727665223a2022626e313238222c0a20226e5075626c6963223a20312c0a2022766b5f616c7068615f31223a205b0a2020223136383939343232303932343933333830363635343837333639383535383130393835373632393638363038363236343535313233373839393534333235393631303835353038333136393834222c0a2020223131313236353833353134363135313938383337343031383336353035383032333737363538323831303639393639343634333734323436363233383231383834353338343735373430353733222c0a20202231220a205d2c0a2022766b5f626574615f32223a205b0a20205b0a202020223130353037353433343431363332333931373731343434333038313933333738393132393634333533373032303339323435323936363439393239353132383434373139333530373139303631222c0a202020223138323031333232373930363536363638303338353337363031333239303934333136313639353036323932313735363033383035313931373431303134383137343433313834303439323632220a20205d2c0a20205b0a2020202235393730343035313937333238363731303039303135323136333039313533343737373239323932393337383233353435313731303237323530313434323932313939303238333938303036222c0a20202022323037363930363539363732313734323935323635383432343631323236303235333038373633363433313832353734383136333036313737363531303133363032323934393332343039220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a2022766b5f67616d6d615f32223a205b0a20205b0a202020223130383537303436393939303233303537313335393434353730373632323332383239343831333730373536333539353738353138303836393930353139393933323835363535383532373831222c0a202020223131353539373332303332393836333837313037393931303034303231333932323835373833393235383132383631383231313932353330393137343033313531343532333931383035363334220a20205d2c0a20205b0a2020202238343935363533393233313233343331343137363034393733323437343839323732343338343138313930353837323633363030313438373730323830363439333036393538313031393330222c0a2020202234303832333637383735383633343333363831333332323033343033313435343335353638333136383531333237353933343031323038313035373431303736323134313230303933353331220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a2022766b5f64656c74615f32223a205b0a20205b0a202020223136313535363335353730373539303739353339313238333338383434343936313136303732363437373938383634303030323333363837333033363537393032373137373736313538393939222c0a20202022313436373232343732333439323938303131363833343434353438363934333135383230363734303930393138303935303936303031383536393336373331333235363031353836313130220a20205d2c0a20205b0a2020202237323230353537363739373539343133323030383936393138313930363235393336303436303137313539363138373234353934313136393539343830393338373134323531393238383530222c0a2020202233373430373431373935343430343931323335393434383131383135393034313132323532333136363139363338313232393738313434363732343938373730343432393130303235383834220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a2022766b5f616c706861626574615f3132223a205b0a20205b0a2020205b0a20202020223136353338373835373931393736333638393936303238353733303031303437343934323739393731393539363734393736343030333735393038303032343439383032313131313634323130222c0a20202020223137333131303939343030313735383134333834313632323434393931333130383838303638353634333233373031303334313530393136373439383733363031333732303830333636353435220a2020205d2c0a2020205b0a202020202236313930333734323631323833353139303832363032393734393037373739373133333533393036343136303038373536323431383136383330323736303830353538343937363231343838222c0a202020202235393436343937393339393735333233313331353539363039383430333334353032393437323239343434303530383338333937383834313336323631353232343535303639393334313432220a2020205d2c0a2020205b0a20202020223138363630383932323137313138363030363234323531383138313230343435383939393433393433373835363336363033333539343833303731393937333936343236333032353737353730222c0a20202020223138353331363837333330303731303131333737383735343831373030333131303831353638333936313233343335343330323135343534393932313935383533353738333635333934333838220a2020205d0a20205d2c0a20205b0a2020205b0a202020202235343736313237323838343430373734343530383634383539343637313831363436303634373634393935393639323930363035373138313334363736303830353033323731323636373331222c0a202020202233333939353634373234363732323331323632333637383338383035393433343033383036323930363533333636363534393431333132363133383134303232333039353137303335303433220a2020205d2c0a2020205b0a202020202234363732373031363933363638333233313835393434393830363234343234393230393733323433363333383336383934373333373836313237313831383036363435373334393236333232222c0a202020202237343032393237303636353837353830383934393039323235323334373237333737373736313330373331343839343832303238383637363639323038393134383138303237323934393339220a2020205d2c0a2020205b0a20202020223131333435373137303337333630323238323539333037343535363132323231353530323834333834383633323633393638353634373039353435303731383731353431323432363231313530222c0a20202020223133303237353334363430383439333930393135323635373030373135393438313838303033383238353036393239373636323338313237373735323234303034343030393436323533373836220a2020205d0a20205d0a205d2c0a20224943223a205b0a20205b0a202020223137303634303536353134323130313738323639363231323937313530313736373930393435363639373834363433373331323337393439313836353033353639373031313131383435363633222c0a2020202235313630373731383537313732353437303137333130323436393731393631393837313830383732303238333438303737353731323437373437333239313730373638363834333330303532222c0a2020202231220a20205d2c0a20205b0a202020223139353437353336353037353838333635333434373738373233333236353837343535383436373930363432313539383837323631313237383933373330343639353332353133353338383832222c0a202020223130373337343135353934343631393933353037313533383636383934383132363337343332383430333637353632393133393337393230323434373039343238353536323236353030383435222c0a2020202231220a20205d0a205d0a7d");
        let public_bytes = hex!("5b0a20223333220a5d");
        let proof_bytes = hex!("7b0a202020202270695f61223a205b0a20202020202020202235393639313233353232303930383134333631313731353838323238323239333638333332373139363937393839313435393139333131333239393839323032333031303531373936393132222c0a2020202020202020223138393036323636323733383833343231353338353530353435383730333839373630303238323332363432393933373839303436343335353438373539393538303437353133383236343636222c0a20202020202020202231220a202020205d2c0a202020202270695f62223a205b0a20202020202020205b0a202020202020202020202020223133373332383232373534363835323136363939343934333133313330333037393439333134333538333531323634333931363135303236363537363431383737343539333132383035393231222c0a202020202020202020202020223135323432313535383638313334303531303631353139363137393130383334373538363831323133363232333935373637353635323333323031373135343934313633333832303832363331220a20202020202020205d2c0a20202020202020205b0a2020202020202020202020202236303430393838333033393130313739313337393035323237353030343736363932353232373331353436333831343539313932313737323632313935383330313539323735363836393330222c0a2020202020202020202020202236313032393331333130303531343235343832313132323232353436393430303231373233323634323933373234313338333735373439313431373137303237373934383738303034313136220a20202020202020205d2c0a20202020202020205b0a2020202020202020202020202231222c0a2020202020202020202020202230220a20202020202020205d0a202020205d2c0a202020202270695f63223a205b0a20202020202020202238303237343338333430383035313030383233353033393735383530353134323930333931323630303835363035363437383537333333323536333035323134323436373133393837333937222c0a2020202020202020223137333638333534303832333837373936323436393738343933303632363834333639353836303830303739353138383838373934363234383336393730393933373038383330363834323935222c0a20202020202020202231220a202020205d2c0a202020202270726f746f636f6c223a202267726f74683136222c0a20202020226375727665223a2022626e313238220a7d");

        let vk = serde_json::from_str::<JsonVerificationKey<Bn254>>(
            &String::from_utf8(vk_bytes.to_vec()).unwrap(),
        )
        .unwrap();
        let public_input = serde_json::from_str::<JsonPublicInput<ark_bn254::Fr>>(
            &String::from_utf8(public_bytes.to_vec()).unwrap(),
        )
        .unwrap();
        let proof = serde_json::from_str::<JsonProof<Bn254>>(
            &String::from_utf8(proof_bytes.to_vec()).unwrap(),
        )
        .unwrap();
        let pvk = vk.prepare_verifying_key();
        let verified = Groth16::<Bn254>::verify_proof(&pvk, &proof.into(), &public_input.values)
            .expect("can verify");
        assert!(verified)
    }

    #[test]
    fn verify_circom_proof_bls12_381() {
        let vk_bytes = hex!("7b0a202270726f746f636f6c223a202267726f74683136222c0a20226375727665223a2022626c733132333831222c0a20226e5075626c6963223a20312c0a2022766b5f616c7068615f31223a205b0a20202231303036323734363434343234343039323137313836393533323133363632353033313732343334353735333638373137313739363638333734343337333534313634323939313536353333303233383939363633353434333737303432393438353233303339313036383137383730323537222c0a20202231303536353530313631323834383433333836383431383531383734303133383934333030313833313737363836343630333539373738353332343438323933343336373531373436333132343437323437393133383038323736323435373431383332373234393330373238343736353236222c0a20202231220a205d2c0a2022766b5f626574615f32223a205b0a20205b0a2020202233383333323930383735343331303133333233303632353330343738343933353330343138393638333839313533323730343339373533383239303633323537343538363233343533343631353631373935353534323937323839323536323432313232313337323636393534303632323935222c0a2020202232323238313137363932323530353130333031333932323136303036353738393438303433353934303239333839353139363533313230303632373139393936383332313432353036373030303932333537353738303739323633363833313634313633393234333336303439303934393135220a20205d2c0a20205b0a2020202232323339333636363739393535393132333532323632353432373931383938353938303836313535383733333930393938303938353130303836303337323738393836373532353335333731383738383537353939313633363833323030313235363034393632383337373734383536313435222c0a2020202233343234363237393037363439303737343230323332363838383434303738323735333935393938373139363338393932393430363235333433333238353939363134353933323031343132383831333339343935353431343636353537383635313630373039363636363034313331343338220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a2022766b5f67616d6d615f32223a205b0a20205b0a20202022333532373031303639353837343636363138313837313339313136303131303630313434383930303239393532373932373735323430323139393038363434323339373933373835373335373135303236383733333437363030333433383635313735393532373631393236333033313630222c0a2020202233303539313434333434323434323133373039393731323539383134373533373831363336393836343730333235343736363437353538363539333733323036323931363335333234373638393538343332343333353039353633313034333437303137383337383835373633333635373538220a20205d2c0a20205b0a2020202231393835313530363032323837323931393335353638303534353231313737313731363338333030383638393738323135363535373330383539333738363635303636333434373236333733383233373138343233383639313034323633333333393834363431343934333430333437393035222c0a20202022393237353533363635343932333332343535373437323031393635373736303337383830373537373430313933343533353932393730303235303237393738373933393736383737303032363735353634393830393439323839373237393537353635353735343333333434323139353832220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a2022766b5f64656c74615f32223a205b0a20205b0a20202022343037323833303334363736313931383238333934363135323932343931363135383638353231363937353031343033353639333136333934333532393539343231323332333034343532323532323235343035363837363035333639363934383636343831343439313730353631313237222c0a2020202231393136333130323930313335373238323238313131303432393138343537373036373535313830383433353235373537323538393839333931393138333238383438373634363431323831323035323337393339363337313435393338393037383035363930383438363431393233383730220a20205d2c0a20205b0a20202022373733323230333331313939383030363431303736343238353830303937313934353130393238343739383439393631383431363236313733383834393130383031383132353839323238313231323039313138363431373133303733373135373634373436383130303933343837303636222c0a20202022383432313339393337323433343831303939323237363933383133383735393031363834323236353632343131303338393637343334323231303331333430373133333530353030383038303735393136343638303931313734383631363233343134383030303932383030363938343932220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a2022766b5f616c706861626574615f3132223a205b0a20205b0a2020205b0a2020202022323435393533353837363533373437333634363631323732393936363031333637353137383139353939313336333333353337383936373531333634353636383934353231353135373431323838323531363730303432363234383139313233363533353038363132313038393230313736222c0a202020202231303433343935303136383131393734383236323731303634383935373434353538373939303435363338343137343832303336383236353234363038373833393835303432383136333338383132333532313031363138363037303335313339353137393430363033353733373833383932220a2020205d2c0a2020205b0a202020202231343336303737343033393834343238373132373135353737373135343933313433333830373338343430383430333534363338373633353335363037313134393730303234383138333330343630303436323030313039393038393132363434343034303536363335343831323332393137222c0a202020202232383330323537313735353935303434383232383839363839383034333533323135333034323639343631313136383437323736323439373131333335323335323630333334323331343038353530323631303037333935323032313130313236333530363738393137313537333333313637220a2020205d2c0a2020205b0a202020202231353038373534323930373530303738393130363433313730313336303037303334373135363932373737373536373930303135333936383138343630353133363936343133383534383539363136323839393038333535333835363531383330383439323036393932323139373130333332222c0a2020202022333133393634383435323137373833313536363133313030393831353433303230333938383532383630353835393936393937333935393836373636333332303038323139313137393839393538323533383137343830393332313033303135373436363938383431313230303037363630220a2020205d0a20205d2c0a20205b0a2020205b0a202020202232333935303235333638313236353534353132333833303431353238363936343530313739353531373730323036383535363233393436343938353336363334353936393431393335333530323332373539303037363431383937393830353432383636313031373239333533303337333334222c0a2020202022363732313535353230363232313134333433313137393531343033333138333734333335393732373332323438323337313034313434343438303434363139393932383330333237333536383638383131323638393137363531333035383431373731303834333037333230353931323637220a2020205d2c0a2020205b0a202020202233353938363033383634363333343837303032333030373734343031343538373731323139363030333632313331343734333936353335323239383731353339363130323838313131393130313034353931333735303033303539313235333030323937343231313632363937383434313133222c0a202020202233363339363039393535393235313334373030333738373532313231303538303139323634383736333037343735383134343532393336313330313432363537393137373437393032343335383537363738313232363937313236393130393632373438323932333932353439313533303935220a2020205d2c0a2020205b0a2020202022353532303031313533393135313532353030353637333135353232303731363937363733313131313232333236343537333035313138383138383733303631313930363037373936393334353137353530333438363230373937343335343532363434333130323236333630353632343835222c0a202020202231323734303838323939323538343335393938333133303739383132363834373634353536303236353333343538343633333037343639363638383039333636303739353839323034383530353930373238363532303235363934333636353731393739353334313339343633313538343233220a2020205d0a20205d0a205d2c0a20224943223a205b0a20205b0a2020202231343935303236353332383938353135363230343639353737363936383435373837333937393734313935333832393438353133373036313130303438323531353037373836303932363637343233313634373134303134313130333237323934353630343334313638303433343530393634222c0a2020202231323635333134383735353432303033363337333632373032393533353937373135383233333037363734313837333732333634313539393738363838333938333530353631393833353837303131393238363834303232353133373132313938353934393231313130353239393536303436222c0a2020202231220a20205d2c0a20205b0a20202022373737343638353338313430343236323731343234353239303934363537333337323135333335353738343934383339383335313530383732363939383437303434303834313739363932393330353532313030323530333437383833343731393835383938373030323030393332383033222c0a2020202232393232363338393433303532353731373638333130323430373134363839343731313936363032383337303136343230373930333931353234363436303333383132323436303138343230373633323334373133343035373338323336313739363131373934373439303935353231343836222c0a2020202231220a20205d0a205d0a7d");
        let public_bytes = hex!("5b0a20223333220a5d");
        let proof_bytes = hex!("7b0a202270695f61223a205b0a20202233313631393038393739363739393236373735313238363830393434363739303731353338373435363638303032373539303334363436313331353333313336333533303634393534303035323037323534333138363638363434343536323834313733343639383035393638373630323734222c0a202022393433353332353933383236323532353939373337383037323030323439343736353333333539393237393731343930353338393631383538313439313233323032303831343031383731353430373037313036363536303436313330393538333338363233393435363633363236313836222c0a20202231220a205d2c0a202270695f62223a205b0a20205b0a202020223835373432353439333435383839383933333434333331383432393934363430373934313132303734353834353136333139373533383135303035313035393031393433333730363839303330313638383331393134353438313038353731363335353735303339393234343737343136222c0a2020202232303633333039373134313337363734363730303036393339343839373837373735383634323539393931363735323837333837333937313839373231333335343436333833363430373732363338383436323935383930333636363831383137333639393630383936313931383035323335220a20205d2c0a20205b0a2020202233303533313438303034353539333530373637393433303532313336353530313431383837323033393934363031373239373534353436343235373234323039373933373933353339393238363839353138393833313438343536343530353536323132383034353534393939333538353131222c0a2020202231353831363236333834393638353739393336383933373433363238343331313131373533353831333639323637353831333833373538313231303732383438333336303033383532313233333134363536393734313032363535303336393931383331343638363635393631343339353432220a20205d2c0a20205b0a2020202231222c0a2020202230220a20205d0a205d2c0a202270695f63223a205b0a20202232383131333035333435323935373831383137333438353239363931353232313234333932393730303039303234383439393533343336353933383838363937303630303638373939363430343739333934303837323136393734393030363734383835363831313137333933313833383237222c0a202022333937383732313131353039323233323431343530323938303832313231353438313939393731343533333537313832373832333938393935383536313432313835313135373639323937353536323038393536353732303830353938343938373736393533393639373838333633323531222c0a20202231220a205d2c0a202270726f746f636f6c223a202267726f74683136222c0a20226375727665223a2022626c733132333831220a7d");

        let vk = serde_json::from_str::<JsonVerificationKey<Bls12_381>>(
            &String::from_utf8(vk_bytes.to_vec()).unwrap(),
        )
        .unwrap();
        let public_input = serde_json::from_str::<JsonPublicInput<ark_bls12_381::Fr>>(
            &String::from_utf8(public_bytes.to_vec()).unwrap(),
        )
        .unwrap();
        let proof = serde_json::from_str::<JsonProof<Bls12_381>>(
            &String::from_utf8(proof_bytes.to_vec()).unwrap(),
        )
        .unwrap();
        let pvk = vk.prepare_verifying_key();
        let verified =
            Groth16::<Bls12_381>::verify_proof(&pvk, &proof.into(), &public_input.values)
                .expect("can verify");
        assert!(verified)
    }

    //this does not work. See https://github.com/TaceoLabs/collaborative-circom/issues/10
    #[ignore]
    #[test]
    fn proof_circom_proof_bls12_381() {
        let mut zkey_bytes = Cursor::new(hex!("7a6b6579010000000a0000000100000004000000000000000100000002000000c40300000000000030000000abaafffffffffeb9ffff53b1feffab1e24f6b0f6a0d23067bf1285f3844b7764d7ac4b43b6a71b4b9ae67f39ea11011a2000000001000000fffffffffe5bfeff02a4bd5305d8a10908d83933487d9d2953a7ed73040000000100000004000000a7f4a3435a9adb8a5fc773751058b6e0876dd7befa41bc22e64cf64617ef25c8debbfc5e04b8f9285b9c2a0c64a667095f4bd860abf69d5faec9718df0a100333133cb9e2057b13574c5e27a9bdf2871cbae6724b6fd2d3d4397b784c7ec6b16f39aba5dba6ab5da6b037256e950c4e6c833d5e906c7771a7bbcef37af56d8d8a897a701829e6f13138eb777f7f24105314e9d10a1b9e0e80e6a945aa42823cf70c4a4ef75686a59384498cacb49957038d5a44b95572bf6cd2f7d4576f79c10d1dfeebd908038ca01b16b6c4cc429a7bc405ab0875d24f0fef41483130c470a4a3759374fa5aec4ce4ee6b88c5af603809824d4b18667af27a21875cd49394e8e93ec77350292a1bfa497589e12087b70dc26a286e772ca786c084975796719f0de55c4dae5daf5e66c749f39509346e01f2c5ebc2b354a3645c29f084a26ce32cb03aa82926e14bb38f57b907dbc078022dd1162631b8dc224803dff4db0372bb7b0936a64c2861f6d5b8cc7ebf9933e2d52e52fa8f004fecb06454f2dfe07100a9402a28ff2f51a96b48726fbf5b380e52a3eb593a8a1e9ae3c1a9d9994986b36631863b7676fd7bc50439291810506f6239e75c0a9a5c360cdbc9dc5a0aa067886e2187eb13b67b34185ccb61a1b478515f20eedb6c2f3ed6073092a92114a4c4960f80a734c5a9c365e1ffa7c595a630aaa6c85e6e75f490d6ee9b5efbba225eff075a9d307e5da807e8efd83005db064df92fcc0addc61142b0a27aa18a0ebe43b6aacad863aa33dc94e5c4979edca3ca4505817e7f21bde63a1c22b0b42d91ae9d5b424cae6e9b21504d4d5bd21e98a021c067bfb6159568b5437c892735967877dd55676a212bf711d37d80d964112e6124d9592e33b0e7f9301913b38136c1157e732eb6a857e13265564de35d2c110bcf11bf6c917dc37d083c3004a17f133f7c71e1ca7726d7fba1073e2d7c2be1170adb975d0a4b171255e9f19b0caa1099da935a352b5e6fa14700308b4b34215490c1ff875b3f1caa5537c522af9395d8402693202833a9a4e6a817fb3ba07c85b85ac157239e34566c56c0baaeebc4516c7ba6aa68e41df761cc44d87704e2e3aba6d11423399e65ffebe47b97816834dc8208ffdcfd699958dfa038f286daf3e8f5626d69ea359bfd8d1147271656b00d6bfc6f5308cfbba2ca8cb8cd396ad3d12b2a2a1a0d9db8f70aa1603000000c0000000000000005938bfb0e94ff416b34eef299152c2f5867dc8cff50e47fd26a31c9f2c1cd8c8a7d1084e77371908b43e59a65ab91c01689fddd9c0dae07b050637a80d9502632f0d452cc16fa50b78a68259372b01f734dca7e4efd8fc9d9fabb29e7ea1840923870351061d6495f6a1a73601e9332a8a0f1a63fc5703108fb4f017ea615c42f007a6baf11d7c7f0516430f4808e40c61a53ba8df38104225409255d03d1ab0ee80e7e3f5ecf34cd833111385c3eed63e4b36d6ea6197e0427fc113edf97f1904000000b4000000000000000400000000000000000000000200000094630d0c6e166636dbff6b7837b65028769e4d9771c3662d377e438a79cda46c0100000000000000030000006d9cf2f390e999c9235c9287cbed6c2b8f3954729614d30511ff599fd9d948070000000001000000000000006d9cf2f390e999c9235c9287cbed6c2b8f3954729614d30511ff599fd9d948070000000002000000010000006d9cf2f390e999c9235c9287cbed6c2b8f3954729614d30511ff599fd9d94807050000008001000000000000478dbc9eff59437cb3a7ffb885c4d7051f976757426a18c07b76ace38984eff68bcced7dbf35462bd6d4d4cee05de01457b8dbb9bd7d62aeb3cb8cee780508ac5d6022ef264d4c719d7a3deddbc61f6bfddf916413f87f8398acf0a24c2e6807dacde9b08be8c275df17261ec281e0427e1239e4cee24b0f995d5f28605ed16d00ad86f39176a81638d99e663e691c14e9d8ad3e002904309871d2bcb4e52da6598fda49be9a037af1a6a5b32c41b730c1f18da29e4e202d438a3ca8c96b420185e8421fb82627145db7372b82691693237e124afb48cc8499be86eb3fcc5fcf87d0fc144882e1bc9f5f2ceb136716117581cbc220f43ba985c60f7ea874fe1acff364ae0cf49d15ab918bba472a5a06e3156aa732c5a4b06d006e36b9f4660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000800100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000085e8421fb82627145db7372b82691693237e124afb48cc8499be86eb3fcc5fcf87d0fc144882e1bc9f5f2ceb136716113629343ddf0bc3107a394433568bad0355024c4894de92511481f9383d211d5ef496e19b83e2769a2ce61103311d9a19070000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cdd43a66926840ad073c2f32b31c9f02edd5fbd1aa659d59a6060774ef5f238f9b41c737c1ed184786fe310c3f4aa9081c95d7f39ff6dd42de845406d920f0106fcd05d82754beb8bb8c88479e786408b225609ac6d9c5d97c4836a02e7b201112f987d2cb41ed6f3fa353096ada7d394bb4a92d5e682dabb7f25e0e8a01812960457c7f206c7dfd31e3d8e63e7a2b02cb5145b46938610738d3d2b34e3236e071a0d9ca37bbae754215507f056bf839529e48d88049990e636f38d99f06650408000000c0000000000000003ec4b794d9908677ad2ea53bbec18ebd62b7f9e15d11f63085d3b6b875fca6b3bcee500921584275500e6e2b6cfef7138f19367bc634beab3ae81d28e89373548a20800075be01c0079e4662034e7e5eb46fc065e6e22f4b98a495a14d98b20fbc598f4446bf50432a9e3282c2bb1c79ff16db8f8bade5dbf61e378e7a5f1c7bc95a967ab3ed3b134bcb5f962bad3d014599da6329f4a039960bb2a2b98aba775970463a466725c85e10c4864180647facef4564d2742c3dd272b9190e28fd0f090000008001000000000000c9269c8102621dc9ca1c420c884f54fc8dfbbc02cc80d9d58dddbd596c578c3d17577493ee73401edd027f4dccaaa90a0ba4e3f0492a5d3ca527c253d853b8c9f2a2993b535da7c8210c4f716eed4b36e242421db4a1d8537e1dd164d8300115be3aa30cebf014d7d932e0bfe6249f4ddf02ea63fe767f1402547da23a66abfc6e9a3f35404b428100fd39d947926801a85727f198c8d26b3ac43a13e5829d5e20acfa9149d8ba7782f360b54aa85b4ebe7c00aa77b1c0657c540da1e4c092016ff534c5554121c47d19ade5a1fdfed08c6987523dbd6277fb2b30a5fe49f0a9dddc31901a090a3b546ea4427fca4a121ee305b7c11019aa683e78a015a0b61c898f45a0354d28aed74f4c79c315d0ac902f7244f749f1a7d40a4f055187a7095ff7fb23fac7c40a2b16482e1fdc22cf8175064ef1e167c5119331cd9ef25dc4ff93c39cc9c47bca4372b84b0e4d4f0df9c22de48a0803aece32e13f045fe06a2056fc976e0a8871865c2b7c78590f7f71c161aeef6098ae43882ec0a0775a000a0000008202000000000000a613c27c5de6dfa14f3788ed4468a1d5a6a4fcbbca021107e5e6df0d1ddfe661fc68e84374ad9a85d76b49ce9d60b4eb0087993a3faabca07b12823e750cd4450100000042d91ae9d5b424cae6e9b21504d4d5bd21e98a021c067bfb6159568b5437c892735967877dd55676a212bf711d37d80d964112e6124d9592e33b0e7f9301913b38136c1157e732eb6a857e13265564de35d2c110bcf11bf6c917dc37d083c3000d53973ff5a9bc8ebfe3df95aebb0e443386d3122f8134ce6297549b6098fb5079ba37b89a753311da1b38636bcb670096eaa0f574d55e9e1d4352d7d18132f3b8d3e096ee3598e10d284f14b53611394da2905d174ec7fe5e61ec56ee204d0e442deb6c26371e933f901a4efe3bced984056dc591e178f2a699dd29a4ba6b52356c0324c00fde3a82cdf575c57de406f60a89a439d855283c673f0b71a1aa6c525e0e76f29e519d42394e26cf7e29fe8c9b380b1b209d71e03faded5ff652194e4edd1e76dfae8aa3ee8f11ccd022faf796cafb21a9924c4a5c06b713fec54315e1c39b1fa1626b2c7006262a5af205156f0f2583db45267f563daf88d9018a510e2e7f43b63a9709a66a22cd393e9e835a0e4b4f4ca44ec886a38679bc211366b15f49f16ecc869ec60895b6e52648792987d3ccdf73abcbf1966fac6c75c808948a61f7eb858fecf3d88d5633d613e5e39013dba94e1bb3aee3ad12df71594ccac503d099e72cb5a4dbc19f9dbca20fd59df853c5797461fd782516754914a6d417dd1fbf699ae49c24c9f8f599968302311a182230af56f7cf686d038b04cf8152f0e2a7f4a811de4f7eccc1abbe66eeff7a9d66702021fda932f4f9451e0000000016000000011431737420436f6e7472696275746f72204e616d65"));
        let mut witness_bytes = Cursor::new(hex!("77746e7302000000020000000100000028000000000000002000000001000000fffffffffe5bfeff02a4bd5305d8a10908d83933487d9d2953a7ed73040000000200000080000000000000000100000000000000000000000000000000000000000000000000000000000000210000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000"));
        let mut r1cs_bytes = Cursor::new(hex!("723163730100000003000000020000007800000000000000010000000200000000000000fffffffffe5bfeff02a4bd5305d8a10908d83933487d9d2953a7ed7301000000030000000100000000000000000000000000000000000000000000000000000000000000010000000100000000000000fffffffffe5bfeff02a4bd5305d8a10908d83933487d9d2953a7ed730100000040000000000000002000000001000000fffffffffe5bfeff02a4bd5305d8a10908d83933487d9d2953a7ed73040000000100000000000000020000000400000000000000010000000300000020000000000000000000000000000000010000000000000002000000000000000300000000000000"));
        let witness = Witness::<ark_bls12_381::Fr>::from_reader(&mut witness_bytes).unwrap();
        let (pk, _) = ZKey::<Bls12_381>::from_reader(&mut zkey_bytes)
            .unwrap()
            .split();
        let r1cs = R1CS::<Bls12_381>::from_reader(&mut r1cs_bytes).unwrap();
        let circuit = Circuit::new(r1cs, witness);
        let public_inputs = circuit.public_inputs();
        let mut rng = thread_rng();
        let r = <Bls12_381 as Pairing>::ScalarField::rand(&mut rng);
        let s = <Bls12_381 as Pairing>::ScalarField::rand(&mut rng);
        let proof = Groth16::<Bls12_381>::create_proof_with_reduction(circuit, &pk, r, s)
            .expect("proof generation works");
        let pvk = prepare_verifying_key(&pk.vk);
        let verified =
            Groth16::<Bls12_381>::verify_proof(&pvk, &proof, &public_inputs).expect("can verify");
        assert!(verified);
        let ser_proof = serde_json::to_string(&JsonProof::<Bls12_381>::from(proof)).unwrap();
        //fs::write(Path::new("my_cool_proof1.json"), test.clone()).unwrap();
        let der_proof = serde_json::from_str::<JsonProof<Bls12_381>>(&ser_proof).unwrap();
        let verified = Groth16::<Bls12_381>::verify_proof(&pvk, &der_proof.into(), &public_inputs)
            .expect("can verify");
        assert!(verified)
    }

    #[test]
    fn proof_circom_proof_bn254() {
        let mut zkey_bytes = Cursor::new(hex!("7a6b6579010000000a000000010000000400000000000000010000000200000094020000000000002000000047fd7cd8168c203c8dca7168916a81975d588181b64550b829a031e1724e643020000000010000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430040000000100000004000000027e9fb2cb94e617cd71cc2ef8637b40ead6441b089d8ba88f60ce98e87c9117146737fd7cd8fa501f67b70ac52838cc6a7c08099a814e45430874985fd1a80e0ec211c22c964bd5cd445e61a0bfac6d353eb2f0d860e3f86b05ea912ed3b32eaf3045d1d5305dbe0f0b415ec9fd5ce45572436831d88cb4ed7d8844be0b90139a9d12878646b78d32cc7d394c7f446e5bee9bad78cc38233db3e5ef554a952701c8300b58a5338cf86354145f3b8c8cecb394c9b102d8289a70d81df6bcfd2ad8bd985423ab08ee87af16e135869c16024ad30a16b697bafa1e73820d8da81765c28f93acbc9d19014db813ee2433245e24e6f56e7bba1353ea2f7afdb5520c2620bc02d1b5838e72017b493519ebdcdf1a81974726b8fb3b5096af4138571940614ca87d73b4afc4d802585add4360862fa052fc50e9096b7bea3a83f0fe14f6e96b889dfa9d61789b9ef597d27ffefe7d1b23621a9eff06429eaeeb7efd28ee5618c7565b0964bb3c7d3222f957dc76103533be35f9558264fd93e6a0a40d4cc19c40b7d561175b65dc98b92614ddd285a11be8e03cf18267321d5e0a62191f51760b48b5773f5680c494f84f59957624c022fa1facffc2dcaa565bddf109b494d100145a1962f8c1018a7e66ded58529e19446efbc393847ba842881c025d8b2c85bcb10e71ba9c8c31120fae71fa5ed983349384f30519a2c7949d8280a5cb12f9b189bce1c74d03018778c614e09d04905cfeada5e992cbb5d7619202cd49b35b903bf71ec6da3df34317b64ee08c336be712a25696eaa847e990f8929030000008000000000000000bc6933dd9846cd05a4d9641a37bbeb13db86b46015b1f78ba12cbf7296f4f11b44e263a510cd1612aefce8f063b0f8ee0790808e5ca6c53124371d9911feff0544a00e55c32c632390a35e20d1ad882b25f434917da80cdbb1e5cb40b688d72b1fcd57dcf9a06192523cde9efc0bc8f90a8b683ba855e13eed86e89211ba5d1404000000b400000000000000040000000000000000000000020000005a92de414e0f2928ae165d9696ad35d4d7d7c52d79c2062c845be361c17d4d2e010000000000000003000000a76d21ae45e6b81be3595ce3b13afe538580bb533d83498ca5444e7fb1d01602000000000100000000000000a76d21ae45e6b81be3595ce3b13afe538580bb533d83498ca5444e7fb1d01602000000000200000001000000a76d21ae45e6b81be3595ce3b13afe538580bb533d83498ca5444e7fb1d01602050000000001000000000000376ae13e3ec67daf95c78bf929ac32038b9ab751cb5038b1b1c1741cb9cd7b0fcd938d847229faea26b8296a5bcfb5f2395ce66521af09041dcd87a04c9ab521c2ada80dd6091a02f6a373cd8b25404cdb9948044d2b7895a8701ae396dc552ba15dc7bbb2f9d1d45fa2e9073ce6a5e2360d2b0483006ffb50cf3b0757a351303c786effb730f67d404dc88dfd98e3c73045ed6408c318b8f23038db3c2910214aee016adb9f87bd61029e253fed08f753740565a93f322c0179a8e2f06aec00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c786effb730f67d404dc88dfd98e3c73045ed6408c318b8f23038db3c291021fd0e7b6e3bec987e2bc8d342527d78a009e47b1c0d061e8c282789fe81e3772f07000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012303fe547c275b0fc7c3358bb1ee15f4c209584d7e30e4469a9a7265cde271c68d3a5ea5fb2a392c820f4fe7a4b49a75882bf30b56c9d992cf8154c4536dc17cd186b9211092e366e4a038ea9e2331b27f36844dd12fd89359b26cc79471c0da960f490a7467661d530e69c95a538279434a80aec7d6a5bb9ce58538de50807080000008000000000000000454ee619c4f07b4f111a00adbed1265da783bbbf28bc57ee8d60a2915e991401819dc403af67a1efef7024e3b151749cae633e6a582a3bb89bbb4d8e75afef021ae3567ce80d2c00c8e41fcc470b2adee059f1e650982ba5a989b4d8153d270f1ce6b90463d2ef2c6b6a4d95925c25e5e23bf9e6bb6ea43b5aa1ae9dce997e01090000000001000000000000c4e3ec12c510235d6e263f1e7367ee81bb50ef0878e00d669e4d40ac4a490e11e8dc6bb0c90c78f2ebdf46dfbd289e45f74aa72e78e8ec4baaf94420d1fca60b05058fea6355ba4c984f982a05229a9b93f5971437bae66327322914691b4d09d2a84b7926593ae93901f537a13c49d3d1b4f37324c975139c2051e72a23e3240cce6f0675357bcb0a1d5b0c427be3cb4d75eabd17b15ec94bf1ef95b7a82608d0c44e2989b56784f1eb375ebc88d3ba0ef3ce02d6220934ee14a1eb2281102e721b3014e1de6672d2b2cfbd51b11a42ed0bd72356ed19b9ec61d89756da120de089f5c570aaa74bfc59e4ec4f4c6ab4fc130843b01e98f14897b5ebd8aeaf1f0a000000e201000000000000d18d78a175674762ef69537202f163bcf68ad4365446b60a60163c70f08ce738765a4f0ace202dfbc7a59bc908857bf231f2c0c28e43ee6afcd2c704b7d89a99010000004cc19c40b7d561175b65dc98b92614ddd285a11be8e03cf18267321d5e0a62191f51760b48b5773f5680c494f84f59957624c022fa1facffc2dcaa565bddf109fe9539180b6c662f98b6e0fb8a2b89e07534cb916139e428e8be431f6e80711cf8565e631fde06d56e1c4d5250ca6e3b7bb53cd34aa1d787f2e9a99634e26d244c00c34128f4acbe221686fe7b8e31c4473bed6c58fa102ac525629d7d65ea03308fc340098bc56c78eadb551956d1f66af693232bbc75df6bf474c9080da304669467aa327905ef72a039f2031c8f5383d4eec8b1f41be855b8b155504b0e1fb6dd5be0376bec9a1846e496d3ba706913a5409f61bc45929e3fcf3b18c343155643da8c44e0027c5646cb0d2383edc3a1c92e9546d24ff5a346c145ff11342134b337402c210cf58f28a437986b81f1353b0b82fbbb1fcdfd2108ef3e5d6010d45a7de7ab09c65f85d663194d0ba3af7f3af53e28dcf85929878393e282ac7fb12991cdee39319bdd15c5fe3cbe1cfe99b70826fa87806a2a47fdae59a5dc9f0000000016000000011431737420436f6e7472696275746f72204e616d65"));
        let mut witness_bytes = Cursor::new(hex!("77746e73020000000200000001000000280000000000000020000000010000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430040000000200000080000000000000000100000000000000000000000000000000000000000000000000000000000000210000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000"));
        let mut r1cs_bytes = Cursor::new(hex!("7231637301000000030000000200000078000000000000000100000002000000000000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430010000000300000001000000000000000000000000000000000000000000000000000000000000000100000001000000000000f093f5e1439170b97948e833285d588181b64550b829a031e1724e643001000000400000000000000020000000010000f093f5e1439170b97948e833285d588181b64550b829a031e1724e6430040000000100000000000000020000000400000000000000010000000300000020000000000000000000000000000000010000000000000002000000000000000300000000000000"));
        let witness = Witness::<ark_bn254::Fr>::from_reader(&mut witness_bytes).unwrap();
        let (pk, _) = ZKey::<Bn254>::from_reader(&mut zkey_bytes).unwrap().split();
        let r1cs = R1CS::<Bn254>::from_reader(&mut r1cs_bytes).unwrap();
        let circuit = Circuit::new(r1cs, witness);
        let public_inputs = circuit.public_inputs();
        let mut rng = thread_rng();
        let r = <Bn254 as Pairing>::ScalarField::rand(&mut rng);
        let s = <Bn254 as Pairing>::ScalarField::rand(&mut rng);
        let proof =
            Groth16::<Bn254, CircomReduction>::create_proof_with_reduction(circuit, &pk, r, s)
                .expect("proof generation works");
        let pvk = prepare_verifying_key(&pk.vk);
        let verified =
            Groth16::<Bn254>::verify_proof(&pvk, &proof, &public_inputs).expect("can verify");
        assert!(verified);
        let ser_proof = serde_json::to_string(&JsonProof::<Bn254>::from(proof)).unwrap();
        //fs::write(Path::new("my_cool_proof1.json"), test.clone()).unwrap();
        let der_proof = serde_json::from_str::<JsonProof<Bn254>>(&ser_proof).unwrap();
        let verified = Groth16::<Bn254>::verify_proof(&pvk, &der_proof.into(), &public_inputs)
            .expect("can verify");
        assert!(verified);
    }
}
